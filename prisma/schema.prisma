// ---------- Prisma / PostgreSQL ----------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------- Core Catalog ----------
model Game {
  id            String          @id
  name          String
  category      String
  rooms         Room[]
  matches       Match[]
  TimelineEvent TimelineEvent[]

  SponsorGame       SponsorGame[]
  SponsorGameWallet SponsorGameWallet[]
  UserGameWallet    UserGameWallet[]

  UserGameStat    UserGameStat[]
  SponsorGameStat SponsorGameStat[]

  DewanyahGame DewanyahGame[]
}

// ---------- Users ----------
model User {
  id           String   @id @default(uuid())
  publicId     String   @unique @default(cuid())
  email        String   @unique
  displayName  String

  // ✅ make nullable for legacy safety
  passwordHash String?

  createdAt    DateTime @default(now())

  // legacy column kept for compatibility with older frontend
  creditPoints Int      @default(5)
  // رصيد الشراء (عملة المتجر)
  creditBalance Int     @default(0)

  permanentScore Int @default(0)

  // ✅ primary currency (monthly reset)
  pearls         Int  @default(5)
  pearlsSeasonYm Int? // ✅ nullable season marker

  birthDate     DateTime?

  // اختيارات الثيم/الإطار/الكارت الحالية
  themeId String?
  frameId String?
  cardId  String?

  roomsHosted Room[]             @relation("RoomsHosted")
  roomPlayers RoomPlayer[]
  sponsors    UserSponsor[]
  matchParts  MatchParticipant[]
  timeline    TimelineEvent[]
  RoomStake   RoomStake[]

  // موافقات نتائج الغرف
  roomResultVotes RoomResultVote[]

  SponsorGameWallet SponsorGameWallet[]
  UserItem          UserItem[]

  UserGameStat    UserGameStat[]
  SponsorGameStat SponsorGameStat[]
  UserGameWallet  UserGameWallet[]

  DewanyahRequest DewanyahRequest[]
  DewanyahMember  DewanyahMember[]
}

enum StoreKind {
  theme
  frame
  card
}

model StoreItem {
  id          String    @id
  kind        StoreKind
  name        String
  price       Int
  description String?
  preview     String?
  active      Boolean   @default(true)
  owners      UserItem[]
}

model UserItem {
  userId  String
  itemId  String
  ownedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item StoreItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@id([userId, itemId])
  @@index([userId])
}

// ---------- Rooms / Players / Stakes ----------
model Room {
  code       String @id
  gameId     String
  game       Game   @relation(fields: [gameId], references: [id])

  hostUserId String
  host       User   @relation("RoomsHosted", fields: [hostUserId], references: [id])

  sponsorCode String?
  sponsor     Sponsor? @relation("SponsorRooms", fields: [sponsorCode], references: [code], onDelete: SetNull)

  status    String   @default("waiting")
  createdAt DateTime @default(now())

  targetWinPoints Int?
  allowZeroCredit Boolean @default(false)

  timerSec  Int?
  startedAt DateTime?
  hostLat   Float?
  hostLng   Float?
  radiusMeters Int? @default(100)

  players       RoomPlayer[]
  matches       Match[]
  stakes        RoomStake[]
  TimelineEvent TimelineEvent[]

  // نتيجة المباراة + موافقات اللاعبين
  resultStatus     RoomResultStatus @default(waiting)
  resultPayload    Json?
  resultSubmittedBy String?
  resultUpdatedAt  DateTime?
  resultVotes      RoomResultVote[]
}

enum TeamSide {
  A
  B
}

model RoomPlayer {
  roomCode String
  userId   String
  joinedAt DateTime @default(now())

  team     TeamSide? @default(A)
  isLeader Boolean   @default(false)

  room Room @relation(fields: [roomCode], references: [code], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomCode, userId])
}

model RoomStake {
  roomCode   String
  userId     String
  amount     Int
  reservedAt DateTime @default(now())

  room Room @relation(fields: [roomCode], references: [code], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomCode, userId])
}

model RoomResultVote {
  roomCode String
  userId   String
  approve  Boolean
  createdAt DateTime @default(now())

  room Room @relation(fields: [roomCode], references: [code], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomCode, userId])
  @@index([userId])
}

enum RoomResultStatus {
  waiting
  pending
  approved
  rejected
}

// ---------- Sponsors ----------
model Sponsor {
  code   String  @id
  name   String
  active Boolean @default(true)
  imageUrl     String?
  themePrimary String?
  themeAccent  String?
  users  UserSponsor[]

  rooms  Room[] @relation("SponsorRooms")

  SponsorGame       SponsorGame[]
  SponsorGameWallet SponsorGameWallet[]
  matches           Match[] @relation("SponsorMatches")

  SponsorGameStat SponsorGameStat[]
}

model UserSponsor {
  userId      String
  sponsorCode String
  activatedAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)

  @@id([userId, sponsorCode])
}

// ---------- Matches ----------
model Match {
  id        String   @id @default(uuid())
  roomCode  String?
  gameId    String
  createdAt DateTime @default(now())

  sponsorCode String?
  sponsor     Sponsor? @relation("SponsorMatches", fields: [sponsorCode], references: [code], onDelete: SetNull)

  room  Room?              @relation(fields: [roomCode], references: [code], onDelete: SetNull)
  game  Game               @relation(fields: [gameId], references: [id])
  parts MatchParticipant[]
}

model MatchParticipant {
  matchId String
  userId  String
  outcome Outcome

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([matchId, userId])
}

enum Outcome {
  WIN
  LOSS
}

// ---------- Timeline ----------
model TimelineEvent {
  id        String   @id @default(uuid())
  userId    String?
  roomCode  String?
  gameId    String?
  kind      String
  meta      Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  room Room? @relation(fields: [roomCode], references: [code], onDelete: SetNull)
  game Game? @relation(fields: [gameId], references: [id], onDelete: SetNull)
}

// ---------- Sponsor extras ----------
model SponsorGame {
  sponsorCode String
  gameId      String
  prizeAmount Int @default(0)

  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([sponsorCode, gameId])
}

model SponsorGameWallet {
  userId      String
  sponsorCode String
  gameId      String

  pearls   Int   @default(5)
  seasonYm Int?  // ✅ nullable season marker
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([userId, sponsorCode, gameId])
  @@index([sponsorCode, gameId])
  @@index([userId])
}

// ---------- User per-game pearls ----------
model UserGameWallet {
  userId String
  gameId String

  pearls    Int   @default(5)
  seasonYm  Int?  // ✅ nullable season marker
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([userId, gameId])
  @@index([gameId])
  @@index([userId])
}

// ---------- Leaderboards / Stats ----------
model UserGameStat {
  userId String
  gameId String

  wins   Int @default(0)
  losses Int @default(0)
  streak Int @default(0)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([userId, gameId])
  @@index([gameId])
}

model SponsorGameStat {
  sponsorCode String
  gameId      String
  userId      String

  wins   Int @default(0)
  losses Int @default(0)
  streak Int @default(0)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([sponsorCode, gameId, userId])
  @@index([sponsorCode, gameId])
  @@index([userId])
}

// ---------- Dewanyah / Community Boards ----------
model Dewanyah {
  id              String            @id @default(uuid())
  name            String
  ownerUserId     String
  ownerEmail      String?
  ownerName       String?
  imageUrl        String?
  themePrimary    String?
  themeAccent     String?
  note            String?
  locationLock    Boolean           @default(false)
  radiusMeters    Int?
  requireApproval Boolean           @default(true)
  status          String            @default("active")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  games   DewanyahGame[]
  members DewanyahMember[]
}

model DewanyahGame {
  id          String    @id @default(uuid())
  dewanyahId  String
  gameId      String
  createdAt   DateTime  @default(now())

  dewanyah Dewanyah @relation(fields: [dewanyahId], references: [id], onDelete: Cascade)
  game     Game     @relation(fields: [gameId], references: [id])

  @@index([dewanyahId, gameId])
  @@unique([dewanyahId, gameId])
}

model DewanyahMember {
  id          String    @id @default(uuid())
  dewanyahId  String
  userId      String
  status      String    @default("pending") // pending, approved, rejected, banned
  createdAt   DateTime  @default(now())
  approvedAt  DateTime?

  dewanyah Dewanyah @relation(fields: [dewanyahId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dewanyahId, userId])
  @@index([userId])
}

model DewanyahRequest {
  id              String    @id @default(uuid())
  userId          String
  name            String
  contact         String
  gameId          String?
  note            String?
  requireApproval Boolean   @default(true)
  locationLock    Boolean   @default(false)
  radiusMeters    Int?
  status          String    @default("pending") // pending, approved, rejected
  createdAt       DateTime  @default(now())
  reviewedAt      DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}
